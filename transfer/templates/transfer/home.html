{% extends 'transfer/base.html' %}

{% block title %}Home - File Transfer{% endblock %}

{% block content %}
<h1>Welcome, {{ user.username }}!</h1>
<p><a href="{% url 'upload_file' %}" class="btn">Upload New File</a></p>

<div class="file-list">
    <h2>Received Files ({{ received_files.count }})</h2>
    {% if received_files %}
        {% for file in received_files %}
        <div class="file-item" data-file-id="{{ file.pk }}">
            <p><strong>From:</strong> {{ file.sender.username }}</p>
            <p><strong>File:</strong> <a href="{% url 'file_detail' file.pk %}">{{ file.file.name }}</a></p>
            <p><strong>Date:</strong> {{ file.uploaded_at|date:"Y-m-d H:i" }}</p>

            {% if not file.is_read %}
            <span style="color: #667eea; font-weight: bold;">● New</span>
            {% endif %}

            {% if file.auto_delete and file.opened_at %}
            <span style="color: #e53e3e; font-size: 0.9em;">⏰ Auto-delete enabled</span>
            {% endif %}

            <form method="POST" action="{% url 'delete_file' file.pk %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this file?');">
                {% csrf_token %}
                <button type="submit" class="btn-delete">Delete</button>
            </form>
        </div>
        {% endfor %}
    {% else %}
        <p>No files received yet.</p>
    {% endif %}
</div>

<div class="file-list">
    <h2>Sent Files ({{ sent_files.count }})</h2>
    {% if sent_files %}
        {% for file in sent_files %}
        <div class="file-item" data-file-id="{{ file.pk }}">
            <p><strong>To:</strong> {{ file.receiver.username }}</p>
            <p><strong>File:</strong> <a href="{% url 'file_detail' file.pk %}">{{ file.file.name }}</a></p>
            <p><strong>Date:</strong> {{ file.uploaded_at|date:"Y-m-d H:i" }}</p>
            <p><strong>Status:</strong> {% if file.is_read %}Read{% else %}Unread{% endif %}</p>

            {% if file.auto_delete %}
            <p style="color: #e53e3e; font-size: 0.9em;">⏰ Auto-delete: {% if file.opened_at %}Active{% else %}Pending{% endif %}</p>
            {% endif %}

            <form method="POST" action="{% url 'delete_file' file.pk %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this file?');">
                {% csrf_token %}
                <button type="submit" class="btn-delete">Delete</button>
            </form>
        </div>
        {% endfor %}
    {% else %}
        <p>No files sent yet.</p>
    {% endif %}
</div>

<script>
// Poll for file updates every 5 seconds
function updateFileCounts() {
    fetch('{% url "file_updates" %}')
        .then(response => response.json())
        .then(data => {
            // Update file counts if they changed
            const receivedHeader = document.querySelector('.file-list:first-of-type h2');
            const sentHeader = document.querySelector('.file-list:last-of-type h2');

            const currentReceivedCount = parseInt(receivedHeader.textContent.match(/\d+/)[0]);
            const currentSentCount = parseInt(sentHeader.textContent.match(/\d+/)[0]);

            // Reload page if counts changed (new file or deletion)
            if (data.received_count !== currentReceivedCount || data.sent_count !== currentSentCount) {
                location.reload();
            }
        })
        .catch(error => console.error('Error fetching updates:', error));
}

// Start polling every 5 seconds
setInterval(updateFileCounts, 5000);
</script>
{% endblock %}